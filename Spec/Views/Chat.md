# Chat View Specification

> **Version**: 1.0  
> **Last Updated**: 2026-01-11

## 개요

메인 채팅 화면. Partner와의 대화 및 선택지 시스템.

## UI 구조

```
┌─────────────────────────────────────────┐
│  ← 뒤로   사쿠라 (22)    [👤] ⋮ 메뉴    │
├─────────────────────────────────────────┤
│                                         │
│  [Partner 이미지]                        │
│  ┌───────────────────────────────────┐ │
│  │                                   │ │
│  │     현재 상황 이미지               │ │
│  │                                   │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ═════════════════════════════════════  │
│         💭 Scenario Director            │
│     "비가 내리기 시작한다.              │
│    두 사람의 옷이 점점 젖어간다..."      │
│  ═════════════════════════════════════  │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ [얼굴이 빨개지며 고개를 숙인다]  │   │
│  │ [손으로 뺨을 가린다]             │   │
│  │                                 │   │
│  │ "아... 비가 오네요"              │   │
│  │                                 │   │
│  │ 💭 심장이 너무 빨리 뛴다...      │   │
│  └─────────────────────────────────┘   │
│  사쿠라                                  │
│                                         │
│                   ┌───────────────────┐ │
│                   │ [우산을 기울이며] │ │
│                   │                   │ │
│                   │ "너 다 젖겠어"    │ │
│                   └───────────────────┘ │
│                                     You │
│                                         │
│  🎯 선택지:                              │
│  ┌───────────────────────────────────┐ │
│  │ 우산을 Partner 쪽으로 기울인다     │ │
│  │ "너 다 젖겠어, 이리 와"            │ │
│  │ ✅ 85% | 배려심 있는 행동          │ │
│  └───────────────────────────────────┘ │
│  ...                                    │
│                                         │
│  [다음 챕터 →]                          │
└─────────────────────────────────────────┘
```

---

## 화면 구성 요소

### 1. 헤더

**왼쪽**:
- ← 뒤로 버튼 (세션 리스트로)

**중앙**:
- Partner 이름 + 나이
- 현재 감정 상태 아이콘 (😊 😳 😍 등)

**우측**:
- **[👤] 아이콘**: Partner 프로필 이미지 (원형)
  - 탭하면 StatusView 모달 열림
- ⋮ 메뉴
  - 세션 정보 보기
  - 다음 챕터로 이동
  - 세션 종료

---

### 2. 이미지 영역

**표시 내용**:
- Visual Director가 생성한 현재 상황 이미지
- 탭하면 전체 화면으로 확대

**하단 오버레이**:
- SDXL 태그 (선택적 표시)
- 이미지 저장 버튼

**로딩 상태**:
```
┌───────────────────────────────────┐
│                                   │
│          🎨                       │
│     이미지 생성 중...              │
│     ████████░░░░ 75%              │
│                                   │
└───────────────────────────────────┘
```

---

### 3. 메시지 영역

#### A. Scenario Director 서술 (중앙 정렬, 비주얼 노벨 스타일)

```
═════════════════════════════════════
        💭 Scenario Director
    "비가 내리기 시작한다.
   두 사람의 옷이 점점 젖어간다..."
═════════════════════════════════════
```

**스타일**:
- 중앙 정렬
- 회색 배경 (반투명)
- 이탤릭체
- 상하 구분선 (═)
- 전체 너비 사용

---

#### B. Partner 메시지 (왼쪽 버블)

```
┌─────────────────────────────────┐
│ [얼굴이 빨개지며 고개를 숙인다]  │  ← 행동 (작은 글씨, 회색)
│ [손으로 뺨을 가린다]             │
│                                 │
│ "아... 비가 오네요"              │  ← 대사 (중간 크기)
│ "당신도 젖었잖아요"              │
│                                 │
│ 💭 심장이 너무 빨리 뛴다...      │  ← 속마음 (작은 글씨, 이탤릭)
└─────────────────────────────────┘
사쿠라                               ← 이름 (버블 외부 하단)
```

**구조**:
1. **상단**: 행동 (actions 배열)
   - 대괄호 `[]`로 표시
   - 작은 글씨, 회색
   - 여러 개 가능

2. **중앙**: 대사 (dialogues 배열)
   - 따옴표 `""`로 표시
   - 중간 크기, 검은색
   - 여러 줄 가능

3. **하단**: 속마음 (innerThought)
   - 💭 아이콘
   - 작은 글씨, 이탤릭, 연한 회색
   - 항상 표시

**스타일**:
- 왼쪽 정렬
- 둥근 모서리
- 연한 배경색
- 최대 너비 80%

---

#### C. User 메시지 (우측 버블)

```
                  ┌───────────────────┐
                  │ [우산을 기울이며] │  ← 행동 (작은 글씨)
                  │                   │
                  │ "너 다 젖겠어"    │  ← 대사 (있을 경우만)
                  └───────────────────┘
                                    You  ← 라벨
```

**구조**:
1. **상단**: 행동 (action)
   - 대괄호 `[]`로 표시
   - 작은 글씨, 회색
   - 항상 표시

2. **중앙**: 대사 (speech)
   - 따옴표 `""`로 표시
   - 중간 크기
   - **없으면 표시 안 함**

**스타일**:
- 우측 정렬
- 둥근 모서리
- 파란색 배경
- 흰색 텍스트
- 최대 너비 80%

---

### 4. 선택지 영역

#### 선택지 카드
```
┌───────────────────────────────────┐
│ 우산을 Partner 쪽으로 기울인다     │
│ "너 다 젖겠어, 이리 와"            │
│ ✅ 85% | 배려심 있는 행동          │
└───────────────────────────────────┘
```

**구성**:
- **행동** (action): 굵은 글씨
- **대사** (speech): 따옴표, 있을 경우만
- **성공률** (successRate): 아이콘 + 퍼센트
  - ✅ 70%+: 녹색
  - ⚠️ 40-69%: 노란색
  - ❌ 0-39%: 빨간색
- **근거** (reasoning): 작은 글씨

**특수 선택지**:
```
┌───────────────────────────────────┐
│ ⭐ 천천히 옷을 벗기기 시작한다     │
│ "괜찮아?"                          │
│ ⚠️ 60% | 다음 단계로의 진전       │
│ [특수 선택지]                      │
└───────────────────────────────────┘
```
- 별 아이콘
- 다른 색상 (골드)

---

### 5. 하단 액션

**다음 챕터 버튼**:
- 고정 위치 (하단 우측)
- 플로팅 버튼
- 탭하면 Scene Transitioner 실행

---

## 턴 진행 플로우

```
1. User 선택지 선택
   ↓
2. 로딩: Partner Agent 실행
   ↓
3. Partner 반응 표시
   ↓
4. 로딩: Scenario Director 실행
   ↓
5. Scenario Director 서술 표시
   ↓
6. 로딩: Visual Director 실행 (조건부)
   ↓
7. 이미지 표시 (생성된 경우)
   ↓
8. 로딩: Strategist 실행
   ↓
9. 새로운 선택지 표시
```

---

## 로딩 상태

### 처리 단계 인디케이터 (상단 고정)

각 Agent 처리 시 상단에 현재 단계 표시:

```
┌─────────────────────────────────────────┐
│  ← 뒤로   사쿠라 (22)    [👤] ⋮ 메뉴    │
├─────────────────────────────────────────┤
│  ⏳ Partner가 생각하는 중...             │  ← 처리 단계 표시
│  ████████░░░░░░░░ 1/4                   │
└─────────────────────────────────────────┘
```

**단계별 표시**:
1. **Partner Agent** (1/4):
   ```
   ⏳ Partner가 생각하는 중...
   ████████░░░░░░░░ 1/4
   ```

2. **Scenario Director** (2/4):
   ```
   � 상황을 전개하는 중...
   ████████████░░░░ 2/4
   ```

3. **Visual Director** (3/4):
   ```
   🎨 이미지를 생성하는 중...
   ████████████████ 3/4
   ```

4. **Strategist** (4/4):
   ```
   🎯 선택지를 준비하는 중...
   ████████████████████ 4/4
   ```

---

### 1. Partner 응답 대기

**채팅 영역에 로딩 버블 표시**:

```
┌─────────────────────────────────┐
│                                 │
│         �💭 ...                  │
│                                 │
└─────────────────────────────────┘
사쿠라
```

**스타일**:
- 왼쪽 정렬 (Partner 메시지 위치)
- 점 3개 애니메이션 (... → .·. → ··· 반복)
- 연한 회색 배경

---

### 2. Scenario Director 대기

**채팅 영역에 중앙 로딩 표시**:

```
═════════════════════════════════════
        � Scenario Director
            ...
═════════════════════════════════════
```

**스타일**:
- 중앙 정렬
- 점 애니메이션
- 반투명 배경

---

### 3. 이미지 생성 대기 (채팅 메시지 스타일)

**Partner 측면에서 이미지 메시지 로딩**:

```
┌─────────────────────────────────┐
│                                 │
│          🎨                     │
│     이미지 보내는 중...          │
│     ████████░░░░ 75%            │
│                                 │
└─────────────────────────────────┘
사쿠라
```

**진행 단계**:
1. **생성 시작**:
   ```
   ┌─────────────────────────────────┐
   │          🎨                     │
   │     이미지 보내는 중...          │
   │     ░░░░░░░░░░░░ 0%             │
   └─────────────────────────────────┘
   ```

2. **프롬프트 생성 중** (25%):
   ```
   ┌─────────────────────────────────┐
   │          🎨                     │
   │     이미지 보내는 중...          │
   │     ███░░░░░░░░░ 25%            │
   └─────────────────────────────────┘
   ```

3. **이미지 생성 중** (50-90%):
   ```
   ┌─────────────────────────────────┐
   │          🎨                     │
   │     이미지 보내는 중...          │
   │     ████████░░░░ 75%            │
   └─────────────────────────────────┘
   ```

4. **완료** (100%):
   - 로딩 버블이 실제 이미지로 교체
   ```
   ┌─────────────────────────────────┐
   │                                 │
   │     [생성된 이미지]              │
   │                                 │
   └─────────────────────────────────┘
   사쿠라
   ```

**스타일**:
- 왼쪽 정렬 (Partner 메시지 위치)
- 이미지 메시지와 동일한 크기/위치
- 프로그레스 바 애니메이션

---

### 4. 선택지 생성 대기

**선택지 영역에 로딩 표시**:

```
🎯 선택지:
┌───────────────────────────────────┐
│                                   │
│         🎯 ...                    │
│     선택지 준비 중...              │
│                                   │
└───────────────────────────────────┘
```

**스타일**:
- 선택지 카드와 동일한 스타일
- 점 애니메이션

---

## 처리 플로우 시각화

### 전체 턴 진행 예시

```
1. User가 선택지 선택
   ↓
   [상단] ⏳ Partner가 생각하는 중... ████████░░░░░░░░ 1/4
   [채팅] 
   ┌─────────────────────────────────┐
   │         💭 ...                  │
   └─────────────────────────────────┘
   사쿠라
   ↓
2. Partner 응답 표시
   ↓
   [상단] 📝 상황을 전개하는 중... ████████████░░░░ 2/4
   [채팅]
   ═════════════════════════════════════
           💭 Scenario Director
               ...
   ═════════════════════════════════════
   ↓
3. Scenario Director 서술 표시
   ↓
   [상단] 🎨 이미지를 생성하는 중... ████████████████ 3/4
   [채팅]
   ┌─────────────────────────────────┐
   │          🎨                     │
   │     이미지 보내는 중...          │
   │     ████████░░░░ 75%            │
   └─────────────────────────────────┘
   사쿠라
   ↓
4. 이미지 표시 (로딩 버블 → 이미지로 교체)
   ↓
   [상단] 🎯 선택지를 준비하는 중... ████████████████████ 4/4
   [선택지]
   ┌───────────────────────────────────┐
   │         🎯 ...                    │
   │     선택지 준비 중...              │
   └───────────────────────────────────┘
   ↓
5. 선택지 표시 (완료)
```

---

## 에러 상태

### Agent 처리 실패

```
┌─────────────────────────────────┐
│          ⚠️                     │
│                                 │
│     응답 생성에 실패했습니다      │
│                                 │
│      [🔄 다시 시도]             │
└─────────────────────────────────┘
```

### 이미지 생성 실패

```
┌─────────────────────────────────┐
│          ⚠️                     │
│                                 │
│   이미지 생성에 실패했습니다      │
│                                 │
│      [🔄 다시 시도]             │
└─────────────────────────────────┘
사쿠라
```

**옵션**:
- 다시 시도
- 이미지 없이 계속
- 플레이스홀더 이미지 표시

---

## 애니메이션

### 점 애니메이션 (...)
```
... → .·. → ··· → ... (반복)
```
- 속도: 0.5초 간격

### 프로그레스 바
- 부드러운 증가 애니메이션
- 색상: 파란색 → 녹색 (완료 시)

### 로딩 → 콘텐츠 전환
- 페이드 아웃 (로딩)
- 페이드 인 (실제 콘텐츠)
- 0.3초 duration

---

## 성능 고려사항

- **백그라운드 처리**: 모든 Agent 호출 비동기
- **타임아웃**: 각 Agent별 최대 대기 시간 설정
  - Partner: 30초
  - Scenario Director: 20초
  - Visual Director: 60초 (이미지 생성)
  - Strategist: 30초
- **재시도**: 실패 시 자동 재시도 (최대 3회)

---

## 특수 상태

### NSFW 진입
```
┌─────────────────────────────────────────┐
│              🔞                         │
│                                         │
│     성인 콘텐츠가 포함될 수 있습니다      │
│                                         │
│          [계속하기] [취소]              │
└─────────────────────────────────────────┘
```

### 트라우마 감지
```
💔 사쿠라가 불편해하는 것 같다...
```
- 특별한 표시
- Partner의 mood 변화 시각화

---

## 데이터 모델

```dart
class ChatState {
  String sessionId;
  PartnerProfile partner;
  UserProfile user;
  WorldState worldState;
  
  List<ChatTurn> history;
  ChatTurn? currentTurn;
  
  bool isProcessing;
  ProcessingStage? stage;
}

class ChatTurn {
  int turnNumber;
  
  // User
  StrategyChoice? userChoice;
  
  // Partner
  PartnerResponse? partnerResponse;
  
  // Scenario Director
  String? scenarioNarration;
  
  // Visual Director
  String? imageUrl;
  List<String>? sdxlTags;
  
  // Strategist
  List<StrategyChoice>? nextChoices;
}

enum ProcessingStage {
  partner,
  scenarioDirector,
  visualDirector,
  strategist,
}
```

---

## 애니메이션

### 메시지 등장
- 페이드 인 + 슬라이드 업
- 순차적 등장 (서술 → 반응 → 선택지)

### 이미지 전환
- 크로스 페이드
- 새 이미지 생성 시 부드러운 교체

### 선택 시
- 선택된 카드 하이라이트
- 다른 카드 페이드 아웃
- 다음 턴으로 스크롤

---

## 접근성

- **VoiceOver/TalkBack**: 모든 대화와 선택지 읽기
- **다크 모드**: 자동 지원
- **폰트 크기**: 시스템 설정 따름
- **색맹 모드**: 성공률 아이콘에 텍스트 추가

---

## 성능 고려사항

- **이미지 캐싱**: 이전 이미지 메모리 보관
- **무한 스크롤**: 가상화로 긴 대화 처리
- **백그라운드 처리**: Agent 호출 비동기 처리

---

## 변경 이력

| 날짜 | 변경 내용 |
|---|---|
| 2026-01-11 | 초안 작성: 채팅 화면 UI 스펙 정의 |
