# Qualia App UI/기능 버그 수정 계획

**작성일**: 2026-01-12

## 문제 요약

1. **다크모드/라이트모드 적용 안됨**
2. **OpenRouter API Key Verify 결과 안 뜸**
3. **셀 선택 이펙트 이상함**
4. **iOS 26 스타일 UI 부족**

---

## 수정 파일 목록

| 파일 | 수정 내용 |
|------|----------|
| `lib/providers/storage_provider.dart` | `keepAlive: true` 추가 |
| `lib/app.dart` | Storage 초기화 대기 로직 추가 |
| `lib/providers/settings_provider.dart` | `setThemeMode`에서 state 직접 업데이트 |
| `lib/services/openrouter_service.dart` | AccountInfo 모델 수정 (API 응답 구조 반영) |
| `lib/providers/openrouter_provider.dart` | `setApiKey` 로직 개선 |
| `lib/config/theme.dart` | iOS 26 스타일 배경색 추가 |
| `lib/widgets/glass_card.dart` | 다층 그림자, 균형 불투명도, 애니메이션 |
| `lib/views/settings/settings_view.dart` | AnimatedContainer 적용 |

---

## Phase 1: 기반 인프라

### 1.1 storage_provider.dart

**문제**: `StorageInitialized` provider가 `keepAlive: true`가 없어서 dispose될 수 있음

**수정**:
```dart
// keepAlive: true 추가
@Riverpod(keepAlive: true)
class StorageInitialized extends _$StorageInitialized {
  @override
  Future<bool> build() async {
    final storage = ref.watch(storageServiceProvider);
    await storage.initialize();
    return true;
  }
}
```

### 1.2 app.dart

**문제**: Storage 초기화 전에 themeMode를 사용함

**수정**:
```dart
@override
Widget build(BuildContext context, WidgetRef ref) {
  final storageInit = ref.watch(storageInitializedProvider);

  return storageInit.when(
    data: (_) {
      final themeMode = ref.watch(themeModeNotifierProvider);
      final locale = ref.watch(localeNotifierProvider);

      return MaterialApp.router(
        themeMode: themeMode,
        // ... 기존 코드
      );
    },
    loading: () => const MaterialApp(
      home: Scaffold(body: Center(child: CircularProgressIndicator())),
    ),
    error: (e, _) => MaterialApp(
      home: Scaffold(body: Center(child: Text('Error: $e'))),
    ),
  );
}
```

---

## Phase 2: 테마/UI 기반

### 2.1 theme.dart - iOS 26 배경색

**문제**: 순백색/순검은색 배경이 iOS 26 스타일이 아님

**수정**:
```dart
static const Color lightBackground = Color(0xFFF2F2F7);  // iOS Light Gray
static const Color darkBackground = Color(0xFF000000);
static const Color darkSurface = Color(0xFF1C1C1E);

// scaffoldBackgroundColor 변경
scaffoldBackgroundColor: lightBackground,  // Light
scaffoldBackgroundColor: darkBackground,   // Dark
```

### 2.2 glass_card.dart - 균형 잡힌 불투명도 + 다층 그림자

**문제**:
- Light/Dark 불투명도 불균형 (Light 71%, Dark 6%)
- 단층 그림자로 깊이감 부족
- 애니메이션 없음

**수정**:
```dart
// 불투명도 균형
Color _getBackgroundColor(bool isDark) {
  return isDark
      ? Colors.white.withAlpha(20)   // ~8% (기존 15 → 20)
      : Colors.white.withAlpha(180); // ~71%
}

// 다층 그림자
List<BoxShadow> _buildShadows(bool isDark) {
  return [
    BoxShadow(color: Colors.black.withAlpha(isDark ? 80 : 8), blurRadius: 8, offset: Offset(0, 2)),
    BoxShadow(color: Colors.black.withAlpha(isDark ? 40 : 5), blurRadius: 20, offset: Offset(0, 8)),
    BoxShadow(color: Colors.black.withAlpha(isDark ? 20 : 3), blurRadius: 40, offset: Offset(0, 16)),
  ];
}

// AnimatedContainer로 변경
AnimatedContainer(
  duration: const Duration(milliseconds: 200),
  curve: Curves.easeInOut,
  // ...
)
```

---

## Phase 3: 설정 Provider

### 3.1 settings_provider.dart

**문제**: `ref.invalidateSelf()` 후 상태 반영이 즉시 안됨

**수정**:
```dart
Future<void> setThemeMode(ThemeMode mode) async {
  final storage = ref.read(storageServiceProvider);
  final modeString = switch (mode) {
    ThemeMode.light => 'light',
    ThemeMode.dark => 'dark',
    ThemeMode.system => 'system',
  };
  await storage.setThemeMode(modeString);
  state = mode;  // invalidateSelf 대신 직접 업데이트
}
```

---

## Phase 4: OpenRouter 관련

### 4.1 openrouter_service.dart - AccountInfo 수정

**문제**: API 응답 구조와 모델이 불일치
- `creditBalance`가 `json['limit']`에서 파싱되지만, 실제로는 `limit - usage`로 계산해야 함
- `rate_limit`은 int가 아니라 Map 객체

**OpenRouter `/auth/key` 실제 응답**:
```json
{
  "data": {
    "label": "string",
    "usage": 0.0,
    "limit": 10.0,
    "is_free_tier": false,
    "rate_limit": {
      "requests": 10,
      "interval": "10s"
    }
  }
}
```

**수정**:
```dart
class AccountInfo {
  final String label;
  final double usage;
  final double? limit;
  final bool isFreeTier;

  double? get creditBalance => limit != null ? limit! - usage : null;

  factory AccountInfo.fromJson(Map<String, dynamic> json) {
    return AccountInfo(
      label: json['label'] as String? ?? '',
      usage: (json['usage'] as num?)?.toDouble() ?? 0.0,
      limit: (json['limit'] as num?)?.toDouble(),
      isFreeTier: json['is_free_tier'] as bool? ?? true,
    );
  }
}
```

### 4.2 openrouter_provider.dart

**문제**: `setApiKey()`에서 `ref.invalidateSelf()` 후 `await future`가 제대로 작동 안함

**수정**:
```dart
Future<bool> setApiKey(String apiKey) async {
  final storage = ref.read(storageServiceProvider);
  await storage.setOpenRouterApiKey(apiKey);

  ref.invalidate(openRouterServiceProvider);  // 서비스 재생성
  ref.invalidateSelf();

  try {
    final result = await future;
    return result != null;
  } catch (e) {
    return false;
  }
}
```

---

## Phase 5: UI 컴포넌트

### 5.1 settings_view.dart - 선택 이펙트 개선

**문제**:
- 애니메이션 없음
- 비선택 상태에서 border가 transparent (레이아웃 점프)
- 배경색 변화 미미

**수정**:
```dart
Widget _buildThemeOption({...}) {
  return Expanded(
    child: GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        curve: Curves.easeInOut,
        decoration: BoxDecoration(
          color: isSelected
              ? primaryColor.withAlpha(50)
              : (isDark ? Colors.grey[850] : Colors.grey[100]),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isSelected
                ? primaryColor
                : (isDark ? Colors.white.withAlpha(20) : Colors.grey.withAlpha(50)),
            width: isSelected ? 2 : 1,
          ),
          boxShadow: isSelected ? [
            BoxShadow(
              color: primaryColor.withAlpha(40),
              blurRadius: 12,
              offset: const Offset(0, 4),
            ),
          ] : null,
        ),
        child: Column(
          children: [
            AnimatedScale(
              duration: const Duration(milliseconds: 150),
              scale: isSelected ? 1.1 : 1.0,
              child: Icon(icon, ...),
            ),
            // ...
          ],
        ),
      ),
    ),
  );
}
```

---

## Phase 6: Build Runner

```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

---

## 검증 방법

### 1. 다크모드/라이트모드
- 설정에서 테마 변경 → 즉시 반영 확인
- 앱 재시작 → 설정 유지 확인

### 2. OpenRouter API Key
- 유효한 키 입력 → "Authenticated" + 잔액 표시
- 잘못된 키 → "Not Connected" 표시

### 3. 선택 이펙트
- 테마/언어 옵션 탭 → 부드러운 애니메이션 전환
- 레이아웃 점프 없음 확인

### 4. iOS 26 스타일
- Light 배경이 #F2F2F7 (순백색 아님) 확인
- GlassCard에 다층 그림자 깊이감 확인
